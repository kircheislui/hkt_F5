---
#
- name: Update SSL Cert
  hosts: all
#  connection: local
  gather_facts: false
  vars:
#  - f5_hostname_to_check: "sbmvno.hkcsl.com"
  - f5_has_server_profile_to_update: false
  - f5_server_profile_to_copy_in_server: []
  - f5_server_profile_to_update: []
  - f5_profile_virtual_server_tobe_updated_with_profile_server: []
  tasks:
    - name: Setup provider
      ansible.builtin.set_fact:
        provider:
          server: "{{ ansible_host }}"
          user: "{{ f5_ui_username }}"
          password: "{{ f5_ui_password }}"
          server_port: "443"
          no_f5_teem: "false"
          validate_certs: false

    - name : Get BIG-IP failover status
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh show sys failover"
      delegate_to: localhost
      register: f5_failoverStatus 

    - name: Get local year in string
      ansible.builtin.command: "date +%Y"
      register: f5_current_year_in_string_command
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - f5_current_year_in_string is not defined
      delegate_to: localhost
      
    - name: Set local year in string
      ansible.builtin.set_fact: 
        f5_current_year_in_string: "{{ f5_current_year_in_string_command.stdout }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - f5_current_year_in_string is not defined
      delegate_to: localhost
      
    - name: Print current year in string
      ansible.builtin.debug: 
        msg: "{{ f5_current_year_in_string  }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      delegate_to: localhost

    - name: Gather F5 Facts
      f5networks.f5_modules.bigip_device_info:
        gather_subset: 
          - ssl-certs
          - client-ssl-profiles
          - server-ssl-profiles
          - virtual-servers
          - irules
        provider: "{{ provider }}"
      register: bigip_facts_result
      delegate_to: localhost
      when: "'active' in f5_failoverStatus['stdout'][0]"

    - name: write result to local
      ansible.builtin.copy:
        content: "{{ bigip_facts_result }}"
        dest: "/tmp/bigip_facts_result2.json"
      when: "'active' in f5_failoverStatus['stdout'][0]"
      delegate_to: localhost
        


    - name: Find out the cert to replace
      ansible.builtin.set_fact:
        f5_cert_to_update: "{{ f5_cert_to_update |default([]) + [ item ]  }}"
      loop: "{{ bigip_facts_result.ssl_certs }}"
      loop_control: 
        label: "{{ item.full_path }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "f5_hostname_to_check in item.subject|default('') or f5_hostname_to_check in item.subject_alternative_name|default('')"


    - name: Print certificate to be updated
      ansible.builtin.debug:
        msg: "{{ f5_cert_to_update }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Find out the client ssl_profile to be copied
      ansible.builtin.set_fact:
        f5_client_profile_to_update: "{{ f5_client_profile_to_update |default([]) + [ item[1] ]  }}"
      loop: "{{ f5_cert_to_update | product(bigip_facts_result.client_ssl_profiles)|list  }}"
      loop_control: 
        label: "{{ item[0].name }} - {{ item[1].name }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "item[0].full_path  == item[1].certificate_file |default('') or item[0].full_path  == item[1].chain_file|default('') or item[0].full_path  == item[1].key_file|default('') "
        
    - name: Print client ssl profiles to be copied
      ansible.builtin.debug:
        msg: "{{ f5_client_profile_to_update }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
       
    - name: Find out the server ssl_profile to be copied
      ansible.builtin.set_fact:
        f5_server_profile_to_update: "{{ f5_server_profile_to_update |default([]) + [ item[1] ]  }}"
      loop: "{{ f5_cert_to_update | product(bigip_facts_result.server_ssl_profiles)|list  }}"
      loop_control: 
        label: "{{ item[0].name }} - {{ item[1].name }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "item[0].full_path  == item[1].key |default('') or item[0].full_path  == item[1].cert|default('') or item[0].full_path  == item[1].ca_file|default('') "

    - name: Check if there is server profile to update
      ansible.builtin.set_fact:
        f5_has_server_profile_to_update: true
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - f5_server_profile_to_update is defined and ( f5_server_profile_to_update|length > 0 )

    - name: Print server ssl profiles to be copied
      ansible.builtin.debug:
        msg: "{{ f5_server_profile_to_update }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
       

    - name: Find out client ssl_profile in use in vserver 
      ansible.builtin.set_fact:
        f5_client_profile_to_copy_in_server: "{{ f5_client_profile_to_copy_in_server |default([]) + [ item[0] | combine({ 'virtual_server': item[1].full_path, 'virtual_server_address': item[1].destination_address|string+':'+item[1].destination_port|string } ) | combine({'virtual_server_profile_list': item[1].profiles }) ]  }}"
      loop: "{{  f5_client_profile_to_update  | product(bigip_facts_result.virtual_servers)|list  }}"
      loop_control: 
        label: "{{ item[0].name }} - {{ item[1].name }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "item[1].profiles | selectattr('full_path','equalto',item[0].full_path ) | list | count > 0 "

    - name: Print client ssl profiles to be copied
      ansible.builtin.debug:
        msg: "{{ f5_client_profile_to_copy_in_server }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Find out server ssl_profile in use in vserver 
      ansible.builtin.set_fact:
        f5_server_profile_to_copy_in_server: "{{ f5_server_profile_to_copy_in_server |default([]) + [ item[0] | combine({ 'virtual_server': item[1].full_path,  'virtual_server_address': item[1].destination_address|string+':'+item[1].destination_port|string } ) | combine({'virtual_server_profile_list': item[1].profiles }) ]  }}"
      loop: "{{  f5_server_profile_to_update  | product(bigip_facts_result.virtual_servers)|list  }}"
      loop_control: 
        label: "{{ item[0].name }} - {{ item[1].name }}"
      when: 
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "item[1].profiles | selectattr('full_path','equalto',item[0].full_path ) | list | count > 0 "

    - name: Print vsserver server ssl profiles to be copied
      ansible.builtin.debug:
        msg: "{{ f5_server_profile_to_copy_in_server }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Upload new cert to F5
      f5networks.f5_modules.bigip_ssl_certificate:
        name: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
        true_names: true
        state: present
        content: "{{ lookup('file','certs/' + f5_hostname_to_check + '/' + f5_current_year_in_string +'.pem' ) }}"
        provider: "{{ provider }}"
      delegate_to: localhost
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Upload new key to F5
      f5networks.f5_modules.bigip_ssl_key:
        name: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
        true_names: true
        state: present
        content: "{{ lookup('file','certs/' + f5_hostname_to_check + '/' + f5_current_year_in_string +'.pem' ) }}"
        provider: "{{ provider }}"
      delegate_to: localhost
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
# Copy certs

    - name : Get SSL Client Profile
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh list ltm profile client-ssl {{ item }} | head -n-1  |tail -n +2 |grep -v inherit-ca-certkeychain |grep -v inherit-certkeychain | sed 's/cert-key-chain/cert-key-chain\ add/g' | tr -d '\n'"
      delegate_to: localhost
      register: f5_profile_client_ssl
      loop: "{{ f5_client_profile_to_copy_in_server | map(attribute='name') |unique }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      
    - name: Print SSL Profile Option Obtained
      ansible.builtin.debug:
        msg: "{{ f5_profile_client_ssl }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Copy Client SSL Profile
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh create ltm profile client-ssl {{ item.item |regex_replace('(.*)(_(.*))$','\\1_Client-'+ f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string + ')$','\\1_Client-'+ f5_current_year_in_string) }} {{ item.stdout[0] }}"
      delegate_to: localhost
      register: f5_profile_client_ssl_create
      loop: "{{ f5_profile_client_ssl.results }}"
      loop_control: 
        label: "{{ item.item |regex_replace('(.*)(_(.*))$','\\1_Client-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Client-'+ f5_current_year_in_string+')$','\\1_Client-'+f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Print result of tmsh create
      ansible.builtin.debug:
        msg: "{{ f5_profile_client_ssl_create }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Get SSL Client Profile Created
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh list ltm profile client-ssl {{  item.item |regex_replace('(.*)(_(.*))$','\\1_Client-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Client-'+ f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string )  }} "
      delegate_to: localhost
      register: f5_profile_client_ssl_create_result
      loop: "{{ f5_profile_client_ssl.results }}"
      loop_control: 
        label: "{{ item.item |regex_replace('(.*)(_(.*))$','\\1_Client-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      failed_when: "'not found' in f5_profile_client_ssl_create_result.stdout[0]"
      
    - name: Print SSL Client Profile Created
      ansible.builtin.debug:
        msg: "{{ f5_profile_client_ssl_create_result }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Get SSL Server Profile
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh list ltm profile server-ssl {{ item }} | head -n-1  |tail -n +2 | tr -d '\n'"
      delegate_to: localhost
      register: f5_profile_server_ssl
      loop: "{{ f5_server_profile_to_copy_in_server | map(attribute='name') |unique }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      
    - name: Print Server SSL Profile Option Obtained
      ansible.builtin.debug:
        msg: "{{ f5_profile_server_ssl }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Copy Server SSL Profile
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh create ltm profile server-ssl {{ item.item |regex_replace('(.*)(_(.*))$','\\1_Server-'+ f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string + ')$','\\1_Server-'+ f5_current_year_in_string) }} {{ item.stdout[0] }}"
      delegate_to: localhost
      register: f5_profile_server_ssl_create
      loop: "{{ f5_profile_server_ssl.results }}"
      loop_control: 
        label: "{{ item.item |regex_replace('(.*)(_(.*))$','\\1_Server-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Server-'+ f5_current_year_in_string+')$','\\1_Server-'+f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Print result of tmsh create Server ssl
      ansible.builtin.debug:
        msg: "{{ f5_profile_server_ssl_create }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Get SSL Server Profile Created
      f5networks.f5_modules.bigip_command:
        provider: "{{ provider }}"
        commands:
          - "tmsh list ltm profile server-ssl {{  item.item |regex_replace('(.*)(_(.*))$','\\1_Server-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Server-'+ f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string )  }} "
      delegate_to: localhost
      register: f5_profile_server_ssl_create_result
      loop: "{{ f5_profile_server_ssl.results }}"
      loop_control: 
        label: "{{ item.item |regex_replace('(.*)(_(.*))$','\\1_Server-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      failed_when: "'not found' in f5_profile_server_ssl_create_result.stdout[0]"
      
    - name: Print SSL Server Profile Created
      ansible.builtin.debug:
        msg: "{{ f5_profile_server_ssl_create_result }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Update SSL Client Profile with name cert created
      f5networks.f5_modules.bigip_profile_client_ssl:
        provider: "{{ provider }}"
        state: present
        name: "{{ item.item  |regex_replace('(.*)(_(.*))$','\\1_Client-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string) }}"
        cert_key_chain:
          - cert: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
            key: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
            chain: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
            true_names: true
      loop: "{{ f5_profile_client_ssl.results }}"
      loop_control:
        label: "{{ item.item  |regex_replace('(.*)(_(.*))$','\\1_Client-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      delegate_to: localhost

#    - name: Update SSL Client Profile with ca file created
#      f5networks.f5_modules.bigip_profile_client_ssl:
#        provider: "{{ provider }}"
#        state: present
#        name: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Client-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string) }}"
#        trusted_cert_authority: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
#      loop: "{{ f5_client_profile_to_copy_in_server }}"
#      loop_control:
#        label: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Client-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+ f5_current_year_in_string) }}"
#      when:
#      - "'active' in f5_failoverStatus['stdout'][0]"
#      - "item.ca_file is defined and (item.ca_file|length  > 0 ) "
#      delegate_to: localhost

    - name: Update SSL Server Profile with key and certfile created
      f5networks.f5_modules.bigip_profile_server_ssl:
        provider: "{{ provider }}"
        state: present
        name: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Server-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string) }}"
        certificate: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
        chain: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
        key: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
      loop: "{{ f5_server_profile_to_copy_in_server }}"
      loop_control:
        label: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Server-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "item.cert is defined and (item.cert |length  > 0 ) "
      delegate_to: localhost

#    - name: Update SSL Server Profile with ca created
#      f5networks.f5_modules.bigip_profile_server_ssl:
#        provider: "{{ provider }}"
#        state: present
#        name: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Server-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string) }}"
#        ca_file: "{{ f5_hostname_to_check }}-{{ f5_current_year_in_string }}"
#      loop: "{{ f5_server_profile_to_copy_in_server }}"
#      loop_control:
#        label: "{{ item.name  |regex_replace('(.*)(_(.*))$','\\1_Server-' + f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+ f5_current_year_in_string) }}"
#      when:
#      - "'active' in f5_failoverStatus['stdout'][0]"
#      - "item.ca_file is defined and (item.ca_file |length  > 0 ) "
#      delegate_to: localhost

    - name : Update Virtual Server (client ssl)
      ansible.builtin.set_fact: 
        f5_profile_virtual_server_tobe_updated_with_profile_client: |
          {% set ns = namespace (profile_lists = [])  %}
          {% for profile in item[0].virtual_server_profile_list %}
          {% if profile.name == item[1] %}
          {% set  ns.profile_lists = ns.profile_lists + [ {'name':  item[1] |regex_replace('(.*)(_(.*))$','\\1_Client-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string+')$','\\1_Client-'+f5_current_year_in_string), 'context': profile.context } ]   %}
          {% else %}
          {% set  ns.profile_lists = ns.profile_lists + [ profile ]   %}
          {% endif %}
          {% endfor %}
          {% set _output = { 'virtual_server': item[0].virtual_server, 'virtual_server_address': item[0].virtual_server_address, 'profile_list': ns.profile_lists } %}
          {{ f5_profile_virtual_server_tobe_updated_with_profile_client |default([]) +  [ _output ] }}
      delegate_to: localhost
      loop: "{{ f5_client_profile_to_copy_in_server  |product( f5_profile_client_ssl.results | map(attribute='item') |unique )}}"
      loop_control: 
        label: "{{ item[0].virtual_server }} - {{ item[1] |regex_replace('(.*)(_(.*))$','\\1_Client-'+f5_current_year_in_string ) | regex_replace('(.+)(?<!_Client-'+f5_current_year_in_string +')$','\\1_Client-'+ f5_current_year_in_string ) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Print Virtual Server Profile to be updated (Client ssl)
      ansible.builtin.debug:
        msg: "{{  f5_profile_virtual_server_tobe_updated_with_profile_client }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Update Virtual Server (server ssl)
      ansible.builtin.set_fact: 
        f5_profile_virtual_server_tobe_updated_with_profile_server: |
          {% set ns = namespace (profile_lists = [])  %}
          {% for profile in item[0].virtual_server_profile_list %}
          {% if profile.name == item[1] %}
          {% set  ns.profile_lists = ns.profile_lists + [ {'name':  item[1] |regex_replace('(.*)(_(.*))$','\\1_Server-'+f5_current_year_in_string) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string+')$','\\1_Server-'+f5_current_year_in_string), 'context': profile.context } ]   %}
          {% else %}
          {% set  ns.profile_lists = ns.profile_lists + [ profile ]   %}
          {% endif %}
          {% endfor %}
          {% set _output = { 'virtual_server': item[0].virtual_server, 'virtual_server_address': item[0].virtual_server_address, 'profile_list': ns.profile_lists } %}
          {{ f5_profile_virtual_server_tobe_updated_with_profile_server |default([]) +  [ _output ] }}
      delegate_to: localhost
      loop: "{{ f5_server_profile_to_copy_in_server  |product( f5_profile_server_ssl.results | map(attribute='item') |unique )}}"
      loop_control: 
        label: "{{ item[0].virtual_server }} - {{ item[1] |regex_replace('(.*)(_(.*))$','\\1_Server-'+f5_current_year_in_string ) | regex_replace('(.+)(?<!_Server-'+f5_current_year_in_string +')$','\\1_Server-'+ f5_current_year_in_string ) }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Print Virtual Server Profile to be updated (server ssl)
      ansible.builtin.debug:
        msg: "{{  f5_profile_virtual_server_tobe_updated_with_profile_server }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Merge Virtual Server List (client + server)
      ansible.builtin.set_fact: 
        f5_profile_virtual_server_tobe_updated_with_profile_all: |
          {% set ns = namespace (profile_lists = [], output_lists =[])  %}
          {% for client_vs in  f5_profile_virtual_server_tobe_updated_with_profile_client %}
          {% for server_vs in f5_profile_virtual_server_tobe_updated_with_profile_server %}
          {% if client_vs.virtual_server == server_vs.virtual_server %}
          {% set  ns.profile_lists = []   %}
          {% for client_profile in client_vs.profile_list %}
          {% for server_profile in server_vs.profile_list %}
          {% if client_profile.context == server_profile.context and client_profile.context == 'server-side' and client_profile.full_path|default('') != server_profile.full_path |default('') %}
          {% set  ns.profile_lists = ns.profile_lists + [ server_profile ]   %}
          {% elif client_profile.context == server_profile.context and client_profile.context == 'client-side' and client_profile.full_path|default('') != server_profile.full_path |default('') %}
          {% set  ns.profile_lists = ns.profile_lists + [ client_profile ]   %}
          {% elif client_profile.context == server_profile.context and client_profile.full_path|default('') == server_profile.full_path|default('') %}
          {% set  ns.profile_lists = ns.profile_lists + [ client_profile ]   %}
          {% endif %}
          {% endfor %}
          {% endfor %}
          {% set ns.output_lists = ns.output_lists + [ { 'virtual_server': client_vs.virtual_server,  'virtual_server_address': client_vs.virtual_server_address, 'profile_list': ns.profile_lists} ] %}
          {% endif %}
          {% endfor %}
          {% endfor %}
          {% for client_vs in f5_profile_virtual_server_tobe_updated_with_profile_client %}
          {% if client_vs.virtual_server not in ( f5_profile_virtual_server_tobe_updated_with_profile_server |map(attribute='virtual_server')|list)  %}
          {% set ns.output_lists = ns.output_lists + [ { 'virtual_server': client_vs.virtual_server, 'virtual_server_address': client_vs.virtual_server_address, 'profile_list': client_vs.profile_list } ] %}
          {% endif%}
          {% endfor %}
          {% for server_vs in f5_profile_virtual_server_tobe_updated_with_profile_server %}
          {% if server_vs.virtual_server not in ( f5_profile_virtual_server_tobe_updated_with_profile_client |map(attribute='virtual_server')|list)  %}
          {% set ns.output_lists = ns.output_lists + [ { 'virtual_server': server_vs.virtual_server, 'virtual_server_address': server_vs.virtual_server_address, 'profile_list': server_vs.profile_list } ] %}
          {% endif%}
          {% endfor %}
          {{ ns.output_lists }}
      delegate_to: localhost
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name: Print Virtual Server Profile to be updated (all)
      ansible.builtin.debug:
        msg: "{{  f5_profile_virtual_server_tobe_updated_with_profile_all }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"


    - name : Update Virtual Server
      f5networks.f5_modules.bigip_virtual_server:
        name: "{{ item.virtual_server }}"
        profiles: "{{ item.profile_list }}"
        provider: "{{ provider }}"
      delegate_to: localhost
      register: f5_update_virtual_server_result
      loop: "{{ f5_profile_virtual_server_tobe_updated_with_profile_all }}"
      loop_control: 
        label: "{{ item.virtual_server }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"

    - name : Verify Virtual Server Updated
      ansible.builtin.shell: |
        sshpass -p "{{ f5_ssl_verify_jump_pass }}" ssh -o StrictHostKeyChecking=no  "{{ f5_ssl_verify_jump_user }}@{{ f5_ssl_verify_jump_host }}" bash -c "echo | openssl s_client -connect {{ item.virtual_server_address }} 2>/dev/null | openssl x509 -noout -subject -issuer -enddate " 
      delegate_to: localhost
      register: f5_verify_virtual_server_result
      loop: "{{ f5_profile_virtual_server_tobe_updated_with_profile_all }}"
      loop_control: 
        label: "{{ item.virtual_server }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"
      - "f5_ssl_verify_jump_host is defined and f5_ssl_verify_jump_user is defined and f5_ssl_verify_jump_pass is defined"


    - name: Print Virtual Server Profile to be updated (all)
      ansible.builtin.debug:
        msg: "{{  f5_verify_virtual_server_result  }}"
      when:
      - "'active' in f5_failoverStatus['stdout'][0]"






#    - name : Get SSL Cert
#      f5networks.f5_modules.bigip_command:
#        provider: "{{ provider }}"
#        commands:
#          - "tmsh list ltm profile server-ssl serverssl-template-default-2021 | head -n-1  |tail -n +2 | tr -d '\n'"
#      delegate_to: localhost
#      register: f5_profile_server_ssl
#      
#    - name: Print SSL Profile Option Obtained
#      ansible.builtin.debug:
#        msg: "{{ f5_profile_server_ssl }}"
#
#    - name : Copy SSL Profile
#      f5networks.f5_modules.bigip_command:
#        provider: "{{ provider }}"
#        commands:
#          - "tmsh create ltm profile server-ssl sunny-server-test {{ f5_profile_server_ssl.stdout[0] }}"
#      delegate_to: localhost
#      register: f5_profile_server_ssl_create
#
#    - name: Print result of tmsh create
#      ansible.builtin.debug:
#        msg: "{{ f5_profile_server_ssl_create }}"


# 1. create certificate
# 2. create ssl profile
# 3. change virtual server ssl profile_client
