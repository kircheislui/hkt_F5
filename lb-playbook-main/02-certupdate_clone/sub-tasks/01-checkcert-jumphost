---
# variables used
#    - f5_hostname_to_check: "sbmvno.hkcsl.com"
#    - f5_ssl_verify_jump_host: '10.168.12.206'
#    - f5_ssl_verify_jump_user: 'root'
#    - f5_ssl_verify_jump_pass: 'adminroot123'

    - name: Get UUID for Tempfile Processing
      ansible.builtin.set_fact: 
        f5_cert_check_tmp_UUID: "{{  '' | to_uuid }}"
      delegate_to: localhost

    - name: Get the cert from a host using openssl command
      ansible.builtin.shell: |
        UUID={{ f5_cert_check_tmp_UUID }}
        echo "/bin/openssl s_client -showcerts -connect {{f5_hostname_to_check}}:443 </dev/null" > /tmp/${UUID}
        sshpass -p "{{ f5_ssl_verify_jump_pass }}" scp -o StrictHostKeyChecking=no /tmp/${UUID}  "{{ f5_ssl_verify_jump_user }}@{{ f5_ssl_verify_jump_host }}":/tmp/${UUID} 
        sshpass -p "{{ f5_ssl_verify_jump_pass }}" ssh -o StrictHostKeyChecking=no  "{{ f5_ssl_verify_jump_user }}@{{ f5_ssl_verify_jump_host }}" bash /tmp/${UUID}
        sshpass -p "{{ f5_ssl_verify_jump_pass }}" ssh -o StrictHostKeyChecking=no  "{{ f5_ssl_verify_jump_user }}@{{ f5_ssl_verify_jump_host }}" rm -f /tmp/${UUID}
        rm -rf /tmp/${UUID}
      register: f5_cert_result
      no_log: False
      delegate_to: localhost

    - name: Print Result
      ansible.builtin.debug: 
        msg: "{{ f5_cert_result.stdout_lines }}"
      delegate_to: localhost

    - name: Write the cert to local temp path
      ansible.builtin.copy: 
        dest: "/tmp/{{ f5_hostname_to_check }}_{{ f5_cert_check_tmp_UUID }}.crt"
        content: "{{ f5_cert_result.stdout }}"
      delegate_to: localhost

    - name: Load the cert to local temp path
      community.crypto.x509_certificate_info:
        path: "/tmp/{{ f5_hostname_to_check }}_{{ f5_cert_check_tmp_UUID }}.crt"
      delegate_to: localhost
      register: f5_playbook_cert

    - name: Print Result
      ansible.builtin.debug: 
        msg: "{{ f5_playbook_cert }}"
      delegate_to: localhost

    - name: Print out cert info
      ansible.builtin.include_tasks: sub-tasks/01-checkcert-common

    - name: Clean up tmp cert created
      ansible.builtin.file:
        path:  "/tmp/{{ f5_hostname_to_check }}_{{ f5_cert_check_tmp_UUID }}.crt"
        state: absent
      delegate_to: localhost

    - name: Setup Output to facts
      ansible.builtin.set_fact:
        f5_check_ssl_cert_in_jumphost: "{{ f5_playbook_cert | combine({ 'days_to_expire': f5_playbook_number_of_expiry_day } ) }}"
      delegate_to: localhost
