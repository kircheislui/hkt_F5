<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F5 BIG-IP Health Check Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f9f9f9; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #005696; border-bottom: 2px solid #ccc; padding-bottom: 10px; text-align: center; }
        .report-meta { text-align: center; color: #555; margin-bottom: 20px; }
        .summary-container { display: flex; justify-content: space-around; text-align: center; padding: 15px; background-color: #f2f2f2; border-radius: 8px; margin-bottom: 20px; }
        .summary-box { padding: 10px 20px; }
        .summary-box .count { font-size: 2em; font-weight: bold; }
        .summary-box .label { font-size: 0.9em; color: #666; }
        .count.total { color: #2980b9; }
        .count.passed { color: #27ae60; }
        .count.failed { color: #c0392b; }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; }
        #searchInput { flex-grow: 1; font-size: 16px; padding: 10px 15px; border: 1px solid #ccc; border-radius: 4px; }
        .toggle-switch { display: flex; align-items: center; gap: 8px; }
        table { border-collapse: collapse; width: 100%; margin: 25px auto; font-size: 0.95em; }
        th, td { border: 1px solid #ddd; text-align: left; padding: 12px; vertical-align: top; }
        th { background-color: #34495e; color: white; font-weight: bold; }
        .status-ok b { color: #155724; }
        .status-fail b { color: #721c24; }
        .hostname-header { background-color: #005696; color: white; font-size: 1.2em; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        .hostname-header.failed { background-color: #c0392b; }
        pre { font-family: "Menlo", "Monaco", "Consolas", "Courier New", monospace; background-color: #eee; padding: 8px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; margin: 0; }
    </style>
</head>
<body>

{#- Pre-calculation block to determine the true status of each F5 device and get accurate counts. -#}
{% set summary = {'total': 0, 'passed': 0, 'failed': 0} %}
{% set host_statuses = {} %}

{% for host in hostvars.keys() %}
    {% if hostvars[host].health_check_results is defined %}
        {% set _ = summary.update({'total': summary.total + 1}) %}
        {% set h = hostvars[host] %}
        {% set host_is_unreachable = namespace(value=false) %}
        {% set host_has_failure = namespace(value=false) %}

        {# --- NEW LOGIC FOR SUMMARY COUNTS --- #}
        {# A host is now considered "failed" for the summary ONLY if it is unreachable. #}
        {% for check in h.health_check_results %}
            {% if check.item == 'Device Reachable' and 'Fail' in check.status %}
                {% set host_is_unreachable.value = true %}
            {% endif %}
            {# This second check is for the RED/BLUE header color logic #}
            {% if 'Fail' in check.status %}
                {% set host_has_failure.value = true %}
            {% endif %}
        {% endfor %}

        {# Update summary counts based on reachability #}
        {% if host_is_unreachable.value %}
            {% set _ = summary.update({'failed': summary.failed + 1}) %}
        {% else %}
            {% set _ = summary.update({'passed': summary.passed + 1}) %}
        {% endif %}
        
        {# Store the status for the header color (red if ANY check failed) #}
        {% if host_has_failure.value %}
            {% set _ = host_statuses.update({host: 'fail'}) %}
        {% else %}
            {% set _ = host_statuses.update({host: 'ok'}) %}
        {% endif %}
    {% endif %}
{% endfor %}

<div class="container">
    <h1>F5 BIG-IP Health Check Report</h1>
    <p class="report-meta"><strong>Report Generated:</strong> {{ ansible_date_time.iso8601 }}</p>

    <div class="summary-container">
        <div class="summary-box">
            <div class="count total">{{ summary.total }}</div>
            <div class="label">Total Devices</div>
        </div>
        <div class="summary-box">
            <div class="count passed">{{ summary.passed }}</div>
            <div class="label">Devices Passed</div>
        </div>
        <div class="summary-box">
            <div class="count failed">{{ summary.failed }}</div>
            <div class="label">Devices with Failures</div>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" onkeyup="filterReport()" placeholder="Search for device names...">
        <div class="toggle-switch">
            <input type="checkbox" id="failuresOnly" onchange="filterReport()">
            <label for="failuresOnly">Show only failures</label>
        </div>
    </div>
  
    <table id="reportTable">
        <thead>
            <tr>
                <th style="width: 20%;">Checking Item</th>
                <th style="width: 25%;">Checking Command / Method</th>
                <th style="width: 15%;">Expected Result</th>
                <th style="width: 30%;">Actual Result</th>
                <th style="width: 10%;">Status</th>
            </tr>
        </thead>
        <tbody>
        {% for host in hostvars.keys() | sort %}
            {% if hostvars[host].health_check_results is defined %}
                {% set h = hostvars[host] %}
                {% set overall_status = host_statuses[host] %}
                
                <tr class="host-section" data-hostname="{{ host }}" data-status="{{ overall_status }}">
                    <td colspan="5" class="hostname-header {{ 'failed' if overall_status == 'fail' }}">Device: {{ host | upper }}</td>
                </tr>

                {% for check in h.health_check_results %}
                    {% if check.item is defined %}
                        {% set row_status = 'ok' if 'OK' in check.status else 'fail' %}
                        <tr class="host-data" data-hostname="{{ host }}" data-status="{{ row_status }}">
                            <td>{{ check.item }}</td>
                            <td><pre>{{ check.command }}</pre></td>
                            <td>{{ check.expected }}</td>
                            <td><pre>{{ check.actual }}</pre></td>
                            <td class="{{ 'status-ok' if row_status == 'ok' else 'status-fail' }}"><b>{{ check.status | upper }}</b></td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function filterReport() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const failuresOnly = document.getElementById('failuresOnly').checked;
        const table = document.getElementById('reportTable');
        const sections = table.getElementsByClassName('host-section');

        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];
            const hostname = section.getAttribute('data-hostname').toLowerCase();
            const hostOverallStatus = section.getAttribute('data-status');
            
            const matchesSearch = hostname.includes(searchText);
            const isFailureHost = hostOverallStatus === 'fail';
            const sectionVisible = matchesSearch && (!failuresOnly || isFailureHost);

            section.style.display = sectionVisible ? '' : 'none';

            const dataRows = table.querySelectorAll('.host-data[data-hostname="' + section.getAttribute('data-hostname') + '"]');
            dataRows.forEach(row => {
                let rowVisible = sectionVisible;
                if (sectionVisible && failuresOnly && row.getAttribute('data-status') === 'ok') {
                    rowVisible = false;
                }
                row.style.display = rowVisible ? '' : 'none';
            });
        }
    }
</script>

</body>
</html>